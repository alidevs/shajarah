{% extends "base.html" %}

{% block title %}صفحة الإدارة{% endblock %}

{% block content %}
<!-- Enhanced Image Fallback System Styles -->
<style>
/* Skeleton Loading Animation */
@keyframes skeleton-pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

.skeleton {
  animation: skeleton-pulse 2s ease-in-out infinite;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
}

@keyframes skeleton-shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

.skeleton-shimmer {
  animation: skeleton-shimmer 1.5s ease-in-out infinite;
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
}

/* Image Loading States */
.image-container {
  position: relative;
  overflow: hidden;
}

.image-loading {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  z-index: 2;
}

.image-error {
  background: linear-gradient(135deg, #fee2e2, #fecaca);
}

/* Gender-specific Avatar Colors */
.avatar-male {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
  color: white;
}

.avatar-female {
  background: linear-gradient(135deg, #ec4899, #be185d);
  color: white;
}

/* Smooth Transitions */
.image-transition {
  transition: opacity 0.3s ease-in-out, transform 0.2s ease-out;
}

.image-hidden {
  opacity: 0;
  transform: scale(0.95);
}

.image-visible {
  opacity: 1;
  transform: scale(1);
}

/* Loading Spinner */
.spinner {
  width: 20px;
  height: 20px;
  border: 2px solid #f3f3f3;
  border-top: 2px solid #3b82f6;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Reduce Motion Support */
@media (prefers-reduced-motion: reduce) {
  .skeleton,
  .skeleton-shimmer,
  .image-transition,
  .spinner {
    animation: none;
  }
  
  .image-transition {
    transition: none;
  }
}

/* RTL-specific Adjustments */
[dir="rtl"] .image-loading {
  transform: translate(50%, -50%);
}

/* Enhanced Arabic Typography */
.arabic-text {
  font-family: 'Cairo', 'Amiri', 'Noto Sans Arabic', system-ui, -apple-system, sans-serif;
  line-height: 1.6;
  letter-spacing: 0.02em;
}

.arabic-heading {
  font-weight: 600;
  line-height: 1.4;
}

/* RTL Layout Improvements */
[dir="rtl"] .flex {
  direction: rtl;
}

[dir="rtl"] .space-x-reverse > :not([hidden]) ~ :not([hidden]) {
  --tw-space-x-reverse: 1;
  margin-right: calc(2rem * var(--tw-space-x-reverse));
  margin-left: calc(2rem * calc(1 - var(--tw-space-x-reverse)));
}
</style>
<div class="mx-auto max-w-7xl space-y-4 p-4 lg:p-8" x-data="adminInterface()">
  <!-- Header Section -->
  <div class="card card-forest fade-in">
    <div class="card-body">
      <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 class="text-2xl lg:text-3xl font-bold text-forest-dark arabic-heading">مرحباً، {{ name }}!</h1>
          <p class="text-gray-600 mt-1 arabic-text">إدارة أفراد العائلة والطلبات</p>
        </div>
        <div class="flex flex-col sm:flex-row gap-2">
          <a href="/" class="btn btn-outline btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2v0"></path>
            </svg>
            عرض الشجرة
          </a>
          <button @click="logout()" class="btn btn-danger btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
            تسجيل الخروج
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Dashboard Summary Cards -->
  <div class="flex flex-col md:flex-row gap-4 slide-in">
    <!-- Total Members Card - Enhanced Interactive -->
    <div class="card cursor-pointer hover:ring-2 hover:ring-forest-light transition-all duration-200 group relative flex-1" 
         @click="ui.activeTab = 'members'">
      <div class="card-body text-center py-2">
        <!-- Hover indicator -->
        <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
          <svg class="w-3 h-3 text-forest-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </div>
        
        <div class="flex items-center justify-center w-10 h-10 bg-forest-light rounded-lg mx-auto mb-1 group-hover:bg-forest-primary transition-colors duration-200">
          <svg class="w-5 h-5 text-forest-dark group-hover:text-white transition-colors duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold text-gray-900" x-text="data.totalMembers || 0">0</h3>
        <p class="text-sm text-gray-600 arabic-text">إجمالي الأعضاء</p>
        
        <!-- Action hint -->
        <div class="mt-1 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
          <span class="text-xs text-forest-primary font-medium arabic-text">انقر للإدارة</span>
        </div>
      </div>
    </div>

    <!-- Pending Requests Card - Enhanced with Urgency -->
    <div class="card cursor-pointer transition-all duration-200 group relative overflow-hidden flex-1" 
         :class="data.totalAddRequests && data.totalAddRequests > 0 ? 
           'hover:ring-2 hover:ring-amber-400 border-r-4 border-r-amber-400 bg-gradient-to-r from-amber-50 to-white' : 
           'hover:ring-2 hover:ring-gray-300'"
         @click="ui.activeTab = 'requests'">
      
      <!-- Urgency indicator for pending requests -->
      <div x-show="data.totalAddRequests && data.totalAddRequests > 0" 
           class="absolute top-0 right-0 w-0 h-0 border-l-[25px] border-l-transparent border-t-[25px] border-t-amber-400">
        <span class="absolute -top-5 right-1 text-white text-xs font-bold rotate-[-45deg]">!</span>
      </div>
      
      <div class="card-body text-center py-2">
        <!-- Hover indicator -->
        <div class="absolute top-2 left-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
          <svg class="w-3 h-3" :class="data.totalAddRequests && data.totalAddRequests > 0 ? 'text-amber-600' : 'text-gray-400'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
          </svg>
        </div>
        
        <div class="flex items-center justify-center w-10 h-10 rounded-lg mx-auto mb-1 transition-colors duration-200"
             :class="data.totalAddRequests && data.totalAddRequests > 0 ? 'bg-amber-100 group-hover:bg-amber-200' : 'bg-gray-100 group-hover:bg-gray-200'">
          <svg class="w-5 h-5" :class="data.totalAddRequests && data.totalAddRequests > 0 ? 'text-amber-600' : 'text-gray-400'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
          </svg>
        </div>
        <h3 class="text-xl font-bold" :class="data.totalAddRequests && data.totalAddRequests > 0 ? 'text-amber-600' : 'text-gray-900'" x-text="data.totalAddRequests || 0">0</h3>
        <p class="text-sm text-gray-600 arabic-text">طلبات الإضافة</p>
        <!-- Status indicators -->
        <div x-show="data.totalAddRequests && data.totalAddRequests > 0" class="mt-1">
          <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-amber-100 text-amber-800 arabic-text">
            يحتاج مراجعة فورية
          </span>
        </div>
        <div x-show="!data.totalAddRequests || data.totalAddRequests === 0" class="mt-1">
          <span class="text-xs text-gray-500 opacity-0 group-hover:opacity-100 transition-opacity duration-200 arabic-text">انقر للمراجعة</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Conditional Alert Banner for Pending Requests -->
  <div x-show="data.totalAddRequests && data.totalAddRequests > 0" 
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0 transform -translate-y-2"
       x-transition:enter-end="opacity-100 transform translate-y-0"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100 transform translate-y-0"
       x-transition:leave-end="opacity-0 transform -translate-y-2"
       class="card border-amber-200 bg-amber-50">
    <div class="card-body">
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <svg class="w-5 h-5 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
          </div>
          <div class="mr-3">
            <h3 class="text-sm font-medium text-amber-800">
              يوجد <span x-text="data.totalAddRequests || 0" class="font-bold"></span> طلب إضافة في انتظار المراجعة
            </h3>
            <p class="text-sm text-amber-600 mt-1">
              يرجى مراجعة الطلبات وقبولها أو رفضها لمساعدة الأعضاء الجدد في الانضمام للعائلة
            </p>
          </div>
        </div>
        <div class="flex-shrink-0">
          <button @click="ui.activeTab = 'requests'" class="btn btn-sm bg-amber-600 hover:bg-amber-700 text-white border-amber-600 hover:border-amber-700">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path>
            </svg>
            مراجعة الطلبات
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Family Members Management Section -->
  <div x-show="ui.activeTab === 'members'" class="card slide-in">
    <div class="card-header">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h2 class="text-xl font-bold text-gray-900 flex items-center">
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
            </svg>
            <span class="arabic-text">إدارة أفراد العائلة</span>
          </h2>
          <p class="text-sm text-gray-600 mt-1 arabic-text">
            عرض وتحرير أعضاء شجرة العائلة - المجموع: <span x-text="data.totalMembers" class="font-medium text-forest-primary">0</span> عضو
          </p>
        </div>
        
        <!-- Action Buttons -->
        <div class="flex flex-col sm:flex-row gap-2">
          <button @click="ui.showAddModal = true; resetForms()" class="btn btn-primary btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
            إضافة عضو جديد
          </button>
          <a href="/api/members/export" download="exported-members.csv" class="btn btn-outline btn-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            تصدير القائمة
          </a>
          <label class="btn btn-secondary btn-sm cursor-pointer">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            رفع قائمة CSV
            <input type="file" accept=".csv" @change="handleCsvUpload($event)" class="hidden" />
          </label>
        </div>
      </div>
    </div>
    
    <div class="bg-white border-b border-gray-200 px-6 py-4">
      <div class="flex flex-wrap items-center justify-between w-full gap-4">
        <!-- Compact Search -->
        <div class="relative min-w-[280px] flex-1">
          <input 
            type="text" 
            x-model="filters.searchQuery" 
            @input="performSearch()"
            class="form-input pr-10 pl-4 py-1.5 text-sm w-full" 
            placeholder="بحث..."
            dir="auto"
          />
          <svg class="w-4 h-4 absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
        </div>
        
        <!-- Separator -->
        <div class="h-6 w-px bg-gray-300 hidden sm:block"></div>
        
        <!-- Gender Toggle Buttons -->
        <div class="flex rounded-lg border border-gray-300 overflow-hidden">
          <button 
            @click="filters.genderFilter = ''; performSearch()" 
            :class="filters.genderFilter === '' ? 'bg-primary-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
            class="px-3 py-1.5 text-sm font-medium transition-colors"
          >
            الكل
          </button>
          <button 
            @click="filters.genderFilter = 'male'; performSearch()" 
            :class="filters.genderFilter === 'male' ? 'bg-primary-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
            class="px-3 py-1.5 text-sm font-medium border-x border-gray-300 transition-colors"
          >
            ذكر
          </button>
          <button 
            @click="filters.genderFilter = 'female'; performSearch()" 
            :class="filters.genderFilter === 'female' ? 'bg-primary-500 text-white' : 'bg-white text-gray-700 hover:bg-gray-50'"
            class="px-3 py-1.5 text-sm font-medium transition-colors"
          >
            أنثى
          </button>
        </div>
        
        <!-- Sort Dropdown -->
        <div class="flex items-center gap-2">
          <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" />
          </svg>
          <select 
            x-model="filters.sortBy" 
            @change="performSearch()" 
            class="form-select pr-8 pl-3 py-1.5 text-sm border-gray-300"
          >
            <option value="name">الاسم</option>
            <option value="id">الرقم</option>
            <option value="birthday">العمر</option>
          </select>
        </div>
        
      </div>
      </div>
    </div>

    <div class="card-body">

      <!-- Members Display -->
      <div x-show="ui.loading" class="text-center py-8">
        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"></div>
        <p class="text-gray-600 mt-2">جاري التحميل...</p>
      </div>

      <!-- Grid View -->
      <div 
        x-show="!ui.loading" 
        class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-2 pb-6"
        id="members-grid"
      >
        <!-- Members will be loaded dynamically via AJAX -->
        <template x-for="member in data.displayedMembers" :key="member.id">
          <div 
            class="bg-white border border-gray-200 rounded-lg hover:shadow-lg transition-all duration-200 overflow-hidden"
            :data-member-id="member.id"
          >
            
            <!-- Enhanced Member Image with Fallback System -->
            <div class="relative h-32 image-container" 
                 x-data="imageHandler(member)" 
                 x-init="initImage()">
              
              <!-- Loading State -->
              <div x-show="imageState === 'loading'" 
                   class="w-full h-full flex items-center justify-center skeleton-shimmer">
                <div class="image-loading">
                  <div class="spinner"></div>
                </div>
              </div>
              
              <!-- User Image (First Priority) -->
              <template x-if="imageState === 'user-image'">
                <img 
                  class="w-full h-full object-cover image-transition image-visible" 
                  :src="member.image" 
                  :alt="generateAltText(member)"
                  loading="lazy"
                  @load="onImageLoad()"
                  @error="onImageError()"
                />
              </template>
              
              <!-- Generated Avatar (Second Priority) -->
              <template x-if="imageState === 'generated-avatar'">
                <div class="w-full h-full flex items-center justify-center image-transition image-visible"
                     :class="getAvatarClass(member.gender)"
                     x-html="generateAvatar(member)">
                </div>
              </template>
              
              <!-- Default Icon (Third Priority) -->
              <template x-if="imageState === 'default-icon'">
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-gray-400 to-gray-600 image-transition image-visible">
                  <svg class="w-16 h-16 text-white opacity-80" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
              </template>
              
              <!-- Error State -->
              <template x-if="imageState === 'error'">
                <div class="w-full h-full flex items-center justify-center image-error">
                  <div class="text-center">
                    <svg class="w-8 h-8 text-red-500 mx-auto mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                    </svg>
                    <p class="text-xs text-red-700">خطأ في التحميل</p>
                    <button @click="retryImage()" class="text-xs text-red-600 hover:text-red-800 underline mt-1">
                      إعادة المحاولة
                    </button>
                  </div>
                </div>
              </template>
              
              <!-- Gender Badge -->
              <div class="absolute top-3 right-3">
                <span 
                  x-show="member.gender === 'male'"
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800"
                >
                  <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5z"/>
                  </svg>
                  ذكر
                </span>
                <span 
                  x-show="member.gender === 'female'"
                  class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-pink-100 text-pink-800"
                >
                  <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M10 2L3 7v11a2 2 0 002 2h10a2 2 0 002-2V7l-7-5z"/>
                  </svg>
                  أنثى
                </span>
              </div>
            </div>
            
            <!-- Member Info -->
            <div class="p-4">
              <div class="mb-3">
                <h3 class="text-lg font-semibold text-gray-900 truncate" x-text="member.name + ' ' + member.last_name">
                </h3>
                <p class="text-sm text-gray-500" x-text="'رقم العضوية: ' + member.id"></p>
              </div>
              
              <!-- Birthday -->
              <div x-show="member.birthday" class="flex items-center text-sm text-gray-600 mb-2">
                <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3a2 2 0 012-2h4a2 2 0 012 2v4m-6 0h6l1 12H7L8 7z"></path>
                </svg>
                <span x-text="member.birthday"></span>
              </div>
              
              <!-- Parents Info -->
              <div class="space-y-1 mb-3">
                <div x-show="member.father_name" class="flex items-center text-xs text-gray-600">
                  <svg class="w-3 h-3 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                  <span x-text="'الوالد: ' + member.father_name"></span>
                </div>
                
                <div x-show="member.mother_name" class="flex items-center text-xs text-gray-600">
                  <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 20 20">
                    <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                  <span x-text="'الوالدة: ' + member.mother_name"></span>
                </div>
              </div>
              
              <!-- Personal Info Preview -->
              <div x-show="member.personal_info && Object.keys(member.personal_info).length > 0" class="mb-3">
                <div class="flex flex-wrap gap-1">
                  <template x-for="[key, value] in Object.entries(member.personal_info || {})" :key="key">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs bg-gray-100 text-gray-700 truncate max-w-20" x-text="key + ': ' + value">
                    </span>
                  </template>
                </div>
              </div>
              
              <!-- Invitation Section (Grid View) -->
              <div x-data="{ showInviteInput: false, email: '' }" class="pt-3 border-t border-gray-100">
                <!-- Invite Input (Initially Hidden) -->
                <div x-show="showInviteInput" x-transition class="mb-3">
                  <div class="flex gap-2">
                    <input 
                      type="email" 
                      x-model="email" 
                      class="form-input text-sm flex-1" 
                      placeholder="البريد الإلكتروني"
                      @keyup.enter="inviteMember(member.id, email); showInviteInput = false; email = ''"
                    />
                    <button 
                      @click="inviteMember(member.id, email); showInviteInput = false; email = ''" 
                      class="btn btn-success btn-sm"
                      :disabled="!email.includes('@')"
                    >
                      إرسال
                    </button>
                    <button 
                      @click="showInviteInput = false; email = ''" 
                      class="btn btn-outline btn-sm"
                    >
                      إلغاء
                    </button>
                  </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex gap-2">
                  <button 
                    @click="viewMember(member.id)" 
                    class="flex-1 btn btn-outline btn-sm"
                    title="عرض التفاصيل"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                    </svg>
                    عرض
                  </button>
                  <button 
                    @click="editMember(member.id)" 
                    class="flex-1 btn btn-secondary btn-sm"
                    title="تحرير"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                    تحرير
                  </button>
                  <button 
                    @click="showInviteInput = !showInviteInput" 
                    class="btn btn-success btn-sm"
                    title="دعوة"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                    </svg>
                  </button>
                  <button 
                    @click="confirmDelete(member.id)" 
                    class="btn btn-danger btn-sm"
                    title="حذف"
                  >
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </template>
      </div>


      <!-- Pagination -->
      <div class="flex justify-between items-center pt-6 border-t border-gray-200">
        <button @click="membersPrevPage()" class="btn btn-outline" :disabled="data.currentPage <= 0">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
          الصفحة السابقة
        </button>
        <div class="text-sm text-gray-600">
          <span x-text="`الصفحة ${data.currentPage + 1}`"></span>
          <span class="mx-2">•</span>
          <span x-text="`${data.displayedMembers.length} من ${data.totalMembers} عضو`"></span>
        </div>
        <button @click="membersNextPage()" class="btn btn-outline" :disabled="data.displayedMembers.length < data.perPage">
          الصفحة التالية
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
          </svg>
        </button>
      </div>
    </div>

    <!-- Add Member Modal (Lightweight Popup) -->
    <div x-show="ui.showAddModal" x-cloak class="fixed inset-0 flex items-center justify-center p-0 md:p-4 z-50" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(2px);">
      <div class="bg-white rounded-none md:rounded-xl w-full md:max-w-4xl h-full md:h-auto max-h-screen overflow-y-auto shadow-2xl md:border md:border-gray-200" @click.away="ui.showAddModal = false" x-transition:enter="transform transition ease-out duration-200" x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100" x-transition:leave="transform transition ease-in duration-150" x-transition:leave-start="scale-100 opacity-100" x-transition:leave-end="scale-95 opacity-0">
        <div class="card-header flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900">إضافة عضو جديد</h3>
          <button @click="ui.showAddModal = false" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="card-body">
          <form id="add-member-form" @submit.prevent="newMember($event)" class="space-y-6">
            <!-- Basic Information Section -->
            <div class="border-b pb-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 ml-2 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                </svg>
                المعلومات الأساسية
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">
                    الاسم الأول <span class="text-red-500">*</span>
                  </label>
                  <input dir="auto" name="name" type="text" required class="form-input" placeholder="ادخل الاسم الأول" />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    الاسم الأخير <span class="text-red-500">*</span>
                  </label>
                  <input dir="auto" name="last_name" type="text" required class="form-input" placeholder="ادخل الاسم الأخير" />
                </div>
                <div class="form-group">
                  <label class="form-label">
                    الجنس <span class="text-red-500">*</span>
                  </label>
                  <select name="gender" required class="form-select">
                    <option value="">اختر الجنس</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    تاريخ الميلاد <span class="text-red-500">*</span>
                  </label>
                  <input dir="auto" name="birthday" type="date" class="form-input" required />
                </div>
              </div>
            </div>

            <!-- Family Relationships Section -->
            <div class="border-b pb-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 ml-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path>
                </svg>
                علاقات القرابة
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label for="new-mother_id" class="form-label">الوالدة</label>
                  <input name="mother_id" type="number" id="new-mother_id"
                    class="form-input" placeholder="ادخل معرف الوالدة (رقم)" />
                  <p class="text-xs text-gray-500 mt-1">يمكنك البحث عن الأعضاء في القائمة أعلاه لمعرفة الأرقام</p>
                </div>
                <div class="form-group">
                  <label for="new-father_id" class="form-label">الوالد</label>
                  <input name="father_id" type="number" id="new-father_id"
                    class="form-input" placeholder="ادخل معرف الوالد (رقم)" />
                  <p class="text-xs text-gray-500 mt-1">يمكنك البحث عن الأعضاء في القائمة أعلاه لمعرفة الأرقام</p>
                </div>
              </div>
            </div>

            <!-- Personal Information Section -->
            <div class="border-b pb-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 ml-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                معلومات شخصية إضافية
              </h4>
              <div class="space-y-3">
                <template x-for="(pair, index) in forms.newMemberPairs" :key="index">
                  <div class="flex gap-3 items-center">
                    <div class="flex-1">
                      <input 
                        type="text" 
                        x-model="pair.key"
                        placeholder="المفتاح (مثل: المهنة)" 
                        class="form-input w-full"
                      />
                    </div>
                    <div class="flex-1">
                      <input 
                        type="text" 
                        x-model="pair.value"
                        placeholder="القيمة (مثل: مهندس)" 
                        class="form-input w-full"
                      />
                    </div>
                    <button 
                      type="button" 
                      @click="forms.newMemberPairs.splice(index, 1)" 
                      class="btn btn-danger btn-sm"
                    >
                      حذف
                    </button>
                  </div>
                </template>
                <button type="button" @click="forms.newMemberPairs.push({key: '', value: ''})" class="btn btn-outline btn-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  إضافة معلومة
                </button>
              </div>
            </div>

            <!-- Image Upload Section -->
            <div class="border-b pb-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                <svg class="w-5 h-5 ml-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                </svg>
                صورة العضو
              </h4>
              <div class="form-group">
                <label class="form-label">اختر صورة</label>
                <input type="file" name="image" accept="image/*" class="form-input" />
                <p class="text-xs text-gray-500 mt-1">الحد الأقصى: 25 ميجابايت</p>
              </div>
            </div>

            <!-- Submit Buttons -->
            <div class="flex justify-end gap-3 pt-6">
              <button type="button" @click="ui.showAddModal = false" class="btn btn-outline">
                إلغاء
              </button>
              <button type="submit" class="btn btn-primary btn-lg">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                </svg>
                إضافة العضو
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- View Member Modal (Lightweight Popup) -->
    <div x-show="ui.showViewModal" x-cloak class="fixed inset-0 flex items-center justify-center p-4 z-50" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(2px);">
      <div class="bg-white rounded-xl max-w-2xl w-full max-h-screen overflow-y-auto shadow-2xl border border-gray-200" @click.away="ui.showViewModal = false" x-transition:enter="transform transition ease-out duration-200" x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100" x-transition:leave="transform transition ease-in duration-150" x-transition:leave-start="scale-100 opacity-100" x-transition:leave-end="scale-95 opacity-0">
        <div class="card-header flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900">تفاصيل العضو</h3>
          <button @click="ui.showViewModal = false" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="card-body" x-show="data.viewingMember">
          <!-- Member Header -->
          <div class="text-center mb-6">
            <div class="w-24 h-24 mx-auto mb-4 rounded-full overflow-hidden image-container"
                 x-data="imageHandler(data.viewingMember)"
                 x-init="initImage()">
              
              <!-- Loading State -->
              <div x-show="imageState === 'loading'" 
                   class="w-full h-full flex items-center justify-center skeleton-shimmer">
                <div class="spinner"></div>
              </div>
              
              <!-- User Image -->
              <template x-if="imageState === 'user-image'">
                <img :src="data.viewingMember.image" 
                     class="w-full h-full object-cover image-transition image-visible" 
                     :alt="generateAltText(data.viewingMember)"
                     @load="onImageLoad()"
                     @error="onImageError()" />
              </template>
              
              <!-- Generated Avatar -->
              <template x-if="imageState === 'generated-avatar'">
                <div class="w-full h-full flex items-center justify-center image-transition image-visible"
                     :class="getAvatarClass(data.viewingMember.gender)"
                     x-html="generateAvatar(data.viewingMember)">
                </div>
              </template>
              
              <!-- Default Icon -->
              <template x-if="imageState === 'default-icon'">
                <div class="w-full h-full flex items-center justify-center bg-primary-100 image-transition image-visible">
                  <svg class="w-12 h-12 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
              </template>
              
            </div>
            <h4 class="text-xl font-semibold text-gray-900" x-text="data.viewingMember?.name + ' ' + data.viewingMember?.last_name"></h4>
            <p class="text-gray-600" x-text="'رقم العضوية: ' + data.viewingMember?.id"></p>
            <div class="flex justify-center mt-2">
              <span 
                x-show="data.viewingMember?.gender === 'male'" 
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800"
              >
                ذكر
              </span>
              <span 
                x-show="data.viewingMember?.gender === 'female'" 
                class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-pink-100 text-pink-800"
              >
                أنثى
              </span>
            </div>
          </div>

          <!-- Member Details -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Basic Information -->
            <div class="space-y-4">
              <h5 class="text-lg font-semibold text-gray-900 border-b pb-2">المعلومات الأساسية</h5>
              
              <div x-show="data.viewingMember?.birthday">
                <label class="text-sm font-medium text-gray-500">تاريخ الميلاد</label>
                <p class="text-gray-900" x-text="data.viewingMember?.birthday"></p>
              </div>
              
              <div x-show="data.viewingMember?.age">
                <label class="text-sm font-medium text-gray-500">العمر</label>
                <p class="text-gray-900" x-text="data.viewingMember?.age + ' سنة'"></p>
              </div>
            </div>

            <!-- Family Relationships -->
            <div class="space-y-4">
              <h5 class="text-lg font-semibold text-gray-900 border-b pb-2">العلاقات العائلية</h5>
              
              <div x-show="data.viewingMember?.father_name">
                <label class="text-sm font-medium text-gray-500">الوالد</label>
                <p class="text-gray-900" x-text="data.viewingMember?.father_name"></p>
              </div>
              
              <div x-show="data.viewingMember?.mother_name">
                <label class="text-sm font-medium text-gray-500">الوالدة</label>
                <p class="text-gray-900" x-text="data.viewingMember?.mother_name"></p>
              </div>
              
              <div x-show="data.viewingMember?.children && data.viewingMember.children?.length > 0">
                <label class="text-sm font-medium text-gray-500">الأطفال</label>
                <div class="space-y-1">
                  <template x-for="child in (data.viewingMember?.children || [])" :key="child.id">
                    <p class="text-gray-900 text-sm" x-text="child.name + ' ' + child.last_name"></p>
                  </template>
                </div>
              </div>
            </div>
          </div>

          <!-- Personal Information -->
          <div x-show="data.viewingMember?.personal_info && Object.keys(data.viewingMember.personal_info).length > 0" class="mt-6">
            <h5 class="text-lg font-semibold text-gray-900 border-b pb-2 mb-4">المعلومات الشخصية</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <template x-for="[key, value] in Object.entries(data.viewingMember?.personal_info || {})" :key="key">
                <div>
                  <label class="text-sm font-medium text-gray-500" x-text="key"></label>
                  <p class="text-gray-900" x-text="value"></p>
                </div>
              </template>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="flex justify-center gap-3 mt-6 pt-6 border-t">
            <button @click="editMember(data.viewingMember.id); ui.showViewModal = false" class="btn btn-secondary">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
              </svg>
              تحرير
            </button>
            <button @click="ui.showViewModal = false" class="btn btn-outline">إغلاق</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Edit Member Modal (Lightweight Popup) -->
    <div x-show="ui.showEditModal" x-cloak class="fixed inset-0 flex items-center justify-center p-4 z-50" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(2px);">
      <div class="bg-white rounded-xl max-w-4xl w-full max-h-screen overflow-y-auto shadow-2xl border border-gray-200" @click.away="ui.showEditModal = false" x-transition:enter="transform transition ease-out duration-200" x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100" x-transition:leave="transform transition ease-in duration-150" x-transition:leave-start="scale-100 opacity-100" x-transition:leave-end="scale-95 opacity-0">
        <div class="card-header flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900">تحرير العضو</h3>
          <button @click="ui.showEditModal = false" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="card-body">
          <template x-if="data.editingMember">
            <form @submit.prevent="saveEditedMember()" class="space-y-6">
              
              <!-- Basic Information -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                  <label class="form-label">الاسم الأول</label>
                  <input type="text" x-model="data.editingMember.name" class="form-input" required />
                </div>
                <div class="form-group">
                  <label class="form-label">الاسم الأخير</label>
                  <input type="text" x-model="data.editingMember.last_name" class="form-input" required />
                </div>
                <div class="form-group">
                  <label class="form-label">الجنس</label>
                  <select x-model="data.editingMember.gender" class="form-select" required>
                    <option value="">اختر الجنس</option>
                    <option value="male">ذكر</option>
                    <option value="female">أنثى</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">
                    تاريخ الميلاد <span class="text-red-500">*</span>
                  </label>
                  <input type="date" x-model="data.editingMember.birthday" class="form-input" required />
                </div>
              </div>

              <!-- Family Relationships -->
              <div class="border-t pt-6">
                <h4 class="text-lg font-semibold text-gray-900 mb-4">علاقات القرابة</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div class="form-group">
                    <label class="form-label">الوالدة</label>
                    <input 
                      type="number" 
                      x-model="data.editingMember.mother_id" 
                      class="form-input" 
                      placeholder="ادخل معرف الوالدة (رقم)"
                    />
                    <p class="text-xs text-gray-500 mt-1">يمكنك استخدام البحث لإيجاد العضو</p>
                  </div>
                  <div class="form-group">
                    <label class="form-label">الوالد</label>
                    <input 
                      type="number" 
                      x-model="data.editingMember.father_id" 
                      class="form-input" 
                      placeholder="ادخل معرف الوالد (رقم)"
                    />
                    <p class="text-xs text-gray-500 mt-1">يمكنك استخدام البحث لإيجاد العضو</p>
                  </div>
                </div>
              </div>

            <!-- Personal Information -->
            <div class="border-t pt-6">
              <h4 class="text-lg font-semibold text-gray-900 mb-4">المعلومات الشخصية</h4>
              <div class="space-y-3">
                <template x-for="(pair, index) in forms.editPairs" :key="index">
                  <div class="flex gap-3 items-center">
                    <div class="flex-1">
                      <input 
                        dir="auto" 
                        x-model="pair.key" 
                        type="text" 
                        class="form-input"
                        placeholder="مثال: المهنة" 
                      />
                    </div>
                    <div class="flex-1">
                      <input 
                        dir="auto" 
                        x-model="pair.value" 
                        type="text" 
                        class="form-input"
                        placeholder="مثال: مهندس" 
                      />
                    </div>
                    <button type="button" @click="forms.editPairs.splice(index, 1)" class="btn btn-danger btn-sm">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                      </svg>
                    </button>
                  </div>
                </template>
                <button type="button" @click="forms.editPairs.push({key: '', value: ''})" class="btn btn-outline btn-sm">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                  </svg>
                  إضافة حقل جديد
                </button>
              </div>
            </div>

            <!-- Image Upload -->
            <div class="border-t pt-6">
              <div class="form-group">
                <label class="form-label">صورة شخصية جديدة</label>
                <input type="file" accept="image/*" class="form-input" x-ref="imageInput" />
                <p class="text-xs text-gray-500 mt-1">يمكنك رفع صورة بحجم أقصى 25 ميجابايت</p>
              </div>
            </div>
            
              <div class="flex justify-end gap-3 pt-6 border-t">
                <button type="button" @click="ui.showEditModal = false" class="btn btn-outline">إلغاء</button>
                <button type="submit" class="btn btn-success">حفظ التغييرات</button>
              </div>
            </form>
          </template>
        </div>
      </div>
    </div>

    <!-- Delete Confirmation Modal (Lightweight Popup) -->
    <div x-show="ui.showDeleteModal" x-cloak class="fixed inset-0 flex items-center justify-center p-4 z-50" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(2px);">
      <div class="bg-white rounded-xl max-w-md w-full shadow-2xl border border-red-200" @click.away="ui.showDeleteModal = false" x-transition:enter="transform transition ease-out duration-200" x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100" x-transition:leave="transform transition ease-in duration-150" x-transition:leave-start="scale-100 opacity-100" x-transition:leave-end="scale-95 opacity-0">
        <div class="card-header">
          <h3 class="text-xl font-bold text-red-900">تأكيد الحذف</h3>
        </div>
        <div class="card-body">
          <div class="flex items-center mb-4">
            <svg class="w-12 h-12 text-red-500 ml-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.082 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
            </svg>
            <div>
              <p class="text-gray-900 font-medium">هل أنت متأكد من حذف هذا العضو؟</p>
              <p class="text-gray-600 text-sm mt-1">هذه العملية لا يمكن التراجع عنها وستؤثر على روابط العائلة.</p>
            </div>
          </div>
        </div>
        <div class="card-footer flex justify-end gap-3">
          <button @click="ui.showDeleteModal = false" class="btn btn-outline">إلغاء</button>
          <button @click="confirmDeleteMember()" class="btn btn-danger">حذف نهائياً</button>
        </div>
      </div>
    </div>

    <!-- Bulk Invite Modal (Lightweight Popup) -->
    <div x-show="ui.showBulkInviteModal" x-cloak class="fixed inset-0 flex items-center justify-center p-4 z-50" style="background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(2px);">
      <div class="bg-white rounded-xl max-w-lg w-full shadow-2xl border border-gray-200" @click.away="ui.showBulkInviteModal = false" x-transition:enter="transform transition ease-out duration-200" x-transition:enter-start="scale-95 opacity-0" x-transition:enter-end="scale-100 opacity-100" x-transition:leave="transform transition ease-in duration-150" x-transition:leave-start="scale-100 opacity-100" x-transition:leave-end="scale-95 opacity-0">
        <div class="card-header flex justify-between items-center">
          <h3 class="text-xl font-bold text-gray-900">دعوة جماعية</h3>
          <button @click="ui.showBulkInviteModal = false" class="text-gray-400 hover:text-gray-600">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
          </button>
        </div>
        <div class="card-body">
          <p class="text-gray-600 mb-4" x-text="`إرسال دعوات لـ ${data.selectedMembers.length} عضو محدد`"></p>
          <div class="form-group">
            <label class="form-label">قائمة البريد الإلكتروني (مفصولة بفواصل)</label>
            <textarea 
              x-model="forms.bulkEmails" 
              class="form-input" 
              rows="4" 
              placeholder="example1@email.com, example2@email.com"
            ></textarea>
          </div>
        </div>
        <div class="card-footer flex justify-end gap-3">
          <button @click="ui.showBulkInviteModal = false" class="btn btn-outline">إلغاء</button>
          <button @click="sendBulkInvites()" class="btn btn-success">إرسال الدعوات</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Requests Management Section -->
  <div x-show="ui.activeTab === 'requests'" id="requests-section" class="card slide-in">
    <div class="card-header">
      <div class="flex flex-col lg:flex-row justify-between items-start lg:items-center gap-4">
        <div>
          <h2 class="text-xl font-bold text-gray-900 flex items-center">
            <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
            </svg>
            <span class="arabic-text">طلبات الإضافة</span>
          </h2>
          <p class="text-sm text-gray-600 mt-1 arabic-text">
            مراجعة وقبول طلبات إضافة أعضاء جدد - المجموع: <span x-text="data.totalAddRequests || 0" class="font-medium" :class="data.totalAddRequests && data.totalAddRequests > 0 ? 'text-amber-600' : 'text-forest-primary'">0</span> طلب
          </p>
        </div>
      </div>
    </div>

    <div class="card-body">
      <!-- Enhanced Empty State for Add Requests -->
      <div x-show="!data.allAddRequests || data.allAddRequests.length === 0" 
           class="text-center py-12 px-6">
        <div class="max-w-sm mx-auto">
          <!-- Animated Icon -->
          <div class="relative mb-6">
            <svg class="w-20 h-20 text-gray-300 mx-auto" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <!-- Floating success indicator -->
            <div class="absolute -top-1 -right-1 w-6 h-6 bg-green-100 rounded-full flex items-center justify-center animate-pulse">
              <svg class="w-3 h-3 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
              </svg>
            </div>
          </div>
          
          <!-- Content -->
          <h3 class="text-lg font-semibold text-gray-900 arabic-heading mb-2">كل شيء محدث!</h3>
          <p class="text-gray-600 mb-6 leading-relaxed arabic-text">
            لا توجد طلبات إضافة في انتظار المراجعة حالياً. 
            <br>سيظهر هنا أي طلبات انضمام جديدة تحتاج لموافقتك.
          </p>
          
          <!-- Action buttons -->
          <div class="flex flex-col sm:flex-row gap-3 justify-center">
            <a href="/invite" class="btn btn-primary arabic-text">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 12a4 4 0 10-8 0 4 4 0 008 0zm0 0v1.5a2.5 2.5 0 005 0V12a9 9 0 10-9 9m4.5-1.206a8.959 8.959 0 01-4.5 1.207"></path>
              </svg>
              دعوة أعضاء جدد
            </a>
            <button @click="loadData()" class="btn btn-outline arabic-text">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              تحديث
            </button>
          </div>
        </div>
      </div>

      <!-- Requests Grid View -->
      <div x-show="data.allAddRequests && data.allAddRequests.length > 0" 
           class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 pb-6">
        <template x-for="request in (data.allAddRequests || [])" :key="request.id">
          <div class="bg-white border border-yellow-200 rounded-lg hover:shadow-lg transition-all duration-200 overflow-hidden border-l-4 border-l-yellow-400">
            
            <!-- Request Member Image -->
            <div class="relative h-32 image-container" 
                 x-data="imageHandler(request)" 
                 x-init="initImage()">
              
              <!-- Loading State -->
              <div x-show="imageState === 'loading'" 
                   class="w-full h-full flex items-center justify-center skeleton-shimmer">
                <div class="image-loading">
                  <div class="spinner"></div>
                </div>
              </div>
              
              <!-- User Uploaded Image -->
              <img x-show="imageState === 'user-image'" 
                   :src="imageSrc"
                   :alt="request.name + ' ' + request.last_name"
                   class="w-full h-full object-cover"
                   @error="handleImageError()"
                   @load="handleImageLoad()" />
              
              <!-- Generated Avatar -->
              <div x-show="imageState === 'generated-avatar'" 
                   :class="request.gender === 'male' ? 'bg-gradient-to-br from-blue-400 to-blue-600' : 
                          request.gender === 'female' ? 'bg-gradient-to-br from-pink-400 to-pink-600' : 
                          'bg-gradient-to-br from-gray-400 to-gray-600'"
                   class="w-full h-full flex items-center justify-center text-white font-bold text-xl"
                   x-html="avatarContent">
              </div>
              
              <!-- Default Icon -->
              <div x-show="imageState === 'default-icon'" 
                   :class="request.gender === 'male' ? 'bg-gradient-to-br from-blue-100 to-blue-200 text-blue-700' : 
                          request.gender === 'female' ? 'bg-gradient-to-br from-pink-100 to-pink-200 text-pink-700' : 
                          'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700'"
                   class="w-full h-full flex items-center justify-center">
                <svg class="w-16 h-16" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                </svg>
              </div>
              
              <!-- Error State with Retry Button -->
              <div x-show="imageState === 'error'" 
                   class="w-full h-full flex flex-col items-center justify-center bg-gray-100 text-gray-500">
                <svg class="w-12 h-12 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <button @click="retryImage()" class="text-xs text-blue-600 hover:text-blue-800 underline">
                  إعادة المحاولة
                </button>
              </div>
            </div>
            
            <div class="p-4">
              <div class="text-center mb-3">
                <h4 class="font-bold text-gray-900" x-text="request.name + ' ' + request.last_name"></h4>
                <p class="text-sm text-gray-600" x-text="'رقم المعرف: ' + request.id"></p>
              </div>
              
              <div class="flex justify-center mb-3">
                <span :class="request.gender === 'male' ? 'bg-blue-100 text-blue-800' : 'bg-pink-100 text-pink-800'"
                      class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium">
                  <span x-text="request.gender === 'male' ? 'ذكر' : 'أنثى'"></span>
                </span>
              </div>
              
              <!-- Family Relations -->
              <div x-show="request.father_name || request.mother_name" class="text-xs text-gray-600 mb-3">
                <div x-show="request.father_name" class="mb-1">
                  <span class="font-medium">الوالد:</span>
                  <span x-text="request.father_name"></span>
                </div>
                <div x-show="request.mother_name">
                  <span class="font-medium">الوالدة:</span>
                  <span x-text="request.mother_name"></span>
                </div>
              </div>
              
              <!-- Personal Info -->
              <div x-show="request.personal_info && Object.keys(request.personal_info).length > 0" class="text-xs text-gray-600 mb-3">
                <template x-for="[key, value] in Object.entries(request.personal_info || {})" :key="key">
                  <div class="mb-1">
                    <span class="font-medium" x-text="key + ':'"></span>
                    <span x-text="value"></span>
                  </div>
                </template>
              </div>
              
              <div class="flex justify-center mb-3">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  معلق
                </span>
              </div>
              
              <div class="flex justify-center gap-2">
                <button @click="approveRequest(request.id)" class="btn btn-sm bg-green-600 hover:bg-green-700 text-white border-green-600 hover:border-green-700">
                  موافقة
                </button>
                <button @click="viewRequest(request.id)" class="btn btn-sm btn-outline">
                  عرض
                </button>
                <button @click="rejectRequest(request.id)" class="btn btn-sm bg-red-600 hover:bg-red-700 text-white border-red-600 hover:border-red-700">
                  رفض
                </button>
              </div>
            </div>
          </div>
        </template>
      </div>
    </div>
  </div>
</div>

<script>
  // Unified Admin Interface Component
  function adminInterface() {
    return {
      // UI State - controls visibility and loading states
      ui: {
        activeTab: 'members', // Default to members tab
        loading: false,
        showAddModal: false,
        showViewModal: false,
        showEditModal: false,
        showDeleteModal: false,
        showBulkInviteModal: false,
      },
      
      // Data State - holds current working data
      data: {
        currentPage: 0,
        perPage: 12,
        totalMembers: 0,
        displayedMembers: [],
        allMembers: [], // Store all members from server
        allAddRequests: [], // Store all add requests from server
        totalAddRequests: 0,
        displayedAddRequests: [],
        selectedMembers: [],
        viewingMember: null,
        editingMember: null,
        deletingMemberId: null,
      },
      
      // Filter State - search and filter criteria
      filters: {
        searchQuery: {% match members_query %}{% when Some with (query) %}{{ query|json }}{% when None %}''{% endmatch %},
        genderFilter: '',
        sortBy: 'name',
        requestsQuery: {% match requests_query %}{% when Some with (query) %}{{ query|json }}{% when None %}''{% endmatch %},
      },
      
      // Form State - form data and temporary state
      forms: {
        newMemberPairs: [{ key: '', value: '' }],
        editPairs: [],
        bulkEmails: '',
      },
      
      init() {
        // Initialize pagination settings
        this.data.perPage = 12;
        
        // Initialize members from server data (JSON string from server)
        const serverMembersRaw = {{ self.members_json()|safe }};
        
        // Process member data (images are now loaded via API when needed)
        const serverMembers = serverMembersRaw.map(member => ({
          ...member,
          image: null, // Images will be loaded via API when needed
          father_name: null, // Will be populated if needed
          mother_name: null, // Will be populated if needed
        }));
        
        // Store all members
        this.data.allMembers = serverMembers;
        this.data.totalMembers = serverMembers.length;
        
        // Initialize add requests from server data
        const serverAddRequestsRaw = {{ self.add_requests_json()|safe }};
        
        // Process add requests data
        const serverAddRequests = serverAddRequestsRaw.map(request => ({
          ...request,
          image: request.image && request.image_type ? 
            `data:${request.image_type};base64,${this.bytesToBase64(request.image)}` : 
            null,
        }));
        
        // Store all add requests
        this.data.allAddRequests = serverAddRequests;
        this.data.totalAddRequests = serverAddRequests.length;
        
        // Initialize search debouncing
        this.searchTimeout = null;
        
        // If we have initial search query from server, apply it
        if (this.filters.searchQuery) {
          this.applyFiltersAndPagination();
        } else {
          // Load initial page of members
          this.loadMembers();
        }
        
        // If there are pending requests, briefly highlight the requests tab
        setTimeout(() => {
          if (this.data.totalAddRequests > 0) {
            // Briefly pulse the requests tab to draw attention
            const requestsTab = document.querySelector('[data-tab="requests"]');
            if (requestsTab) {
              requestsTab.classList.add('animate-pulse');
              setTimeout(() => {
                requestsTab.classList.remove('animate-pulse');
              }, 3000);
            }
          }
        }, 1000);
      },
      
      // Helper Functions
      resetForms() {
        this.forms.newMemberPairs = [{ key: '', value: '' }];
        this.forms.editPairs = [];
        this.forms.bulkEmails = '';
        // Clear form
        this.$nextTick(() => {
          const form = document.querySelector('#add-member-form');
          if (form) {
            form.reset();
          }
        });
      },
      
      // Load members using server-side pagination and search
      async loadMembers() {
        this.ui.loading = true;
        
        try {
          // Build query parameters
          const params = new URLSearchParams();
          
          // Add search query if present
          if (this.filters.searchQuery && this.filters.searchQuery.trim()) {
            params.set('query', this.filters.searchQuery.trim());
          }
          
          // Add pagination parameters
          params.set('page', this.data.currentPage.toString());
          params.set('per_page', this.data.perPage.toString());
          
          // Make API request
          const response = await fetch(`/api/members/flat?${params.toString()}`);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const members = await response.json();
          
          // Apply gender filter client-side (since backend doesn't support it yet)
          let filteredMembers = members;
          if (this.filters.genderFilter) {
            filteredMembers = members.filter(
              member => member.gender === this.filters.genderFilter
            );
          }
          
          // Apply sorting
          this.applySortingToArray(filteredMembers);
          
          // Process images for display
          filteredMembers.forEach(member => {
            if (member.image && member.image_type) {
              member.image = `data:${member.image_type};base64,${this.bytesToBase64(member.image)}`;
            }
          });
          
          this.data.displayedMembers = filteredMembers;
          
          // For pagination UI, we need to estimate total count
          // If we got less than perPage results, we're on the last page
          if (members.length < this.data.perPage) {
            this.data.totalMembers = (this.data.currentPage * this.data.perPage) + members.length;
          } else {
            // Estimate there might be more pages
            this.data.totalMembers = (this.data.currentPage + 1) * this.data.perPage + 1;
          }
          
        } catch (error) {
          console.error('Failed to load members:', error);
          this.showNotification('error', 'خطأ في التحميل', 'فشل في تحميل بيانات الأعضاء');
          this.data.displayedMembers = [];
        } finally {
          this.ui.loading = false;
        }
      },
      
      // Apply filters and pagination
      applyFiltersAndPagination() {
        this.loadMembers();
      },
      
      // Legacy function for backward compatibility
      loadMembersFromCache() {
        // Redirect to new server-side loading
        this.loadMembers();
      },
      
      // Search and Filter Functions
      performSearch() {
        // Clear existing timeout
        if (this.searchTimeout) {
          clearTimeout(this.searchTimeout);
        }
        
        // Debounce search
        this.searchTimeout = setTimeout(() => {
          // Reset to first page when searching
          this.data.currentPage = 0;
          this.loadMembers();
        }, 300);
      },
      
      // Helper function to convert byte array to base64
      bytesToBase64(bytes) {
        if (!bytes || !Array.isArray(bytes)) return '';
        
        // Convert array of numbers to Uint8Array
        const uint8Array = new Uint8Array(bytes);
        
        // Convert to base64
        let binary = '';
        const len = uint8Array.byteLength;
        for (let i = 0; i < len; i++) {
          binary += String.fromCharCode(uint8Array[i]);
        }
        return window.btoa(binary);
      },
      

      
      // Sorting function  
      applySortingToArray(members) {
        if (!members || !members.length) return;
        
        members.sort((a, b) => {
          switch (this.filters.sortBy) {
            case 'name':
              const nameA = (a.name + ' ' + a.last_name).toLowerCase();
              const nameB = (b.name + ' ' + b.last_name).toLowerCase();
              return nameA.localeCompare(nameB);
            
            case 'id':
              return a.id - b.id;
            
            case 'birthday':
              // Handle null birthdays
              if (!a.birthday && !b.birthday) return 0;
              if (!a.birthday) return 1;
              if (!b.birthday) return -1;
              return new Date(a.birthday) - new Date(b.birthday);
            
            default:
              return 0;
          }
        });
      },
      
      // Selection Functions
      toggleAllSelection(event) {
        if (event.target.checked) {
          // Select all visible members (this would need to be populated with actual member IDs)
          this.data.selectedMembers = []; // Would populate with current page member IDs
        } else {
          this.data.selectedMembers = [];
        }
      },
      
      // Modal Functions
      async viewMember(memberId) {
        // Find member in current displayed members first
        let member = this.data.displayedMembers.find(m => m.id == memberId);
        
        if (!member) {
          // If not found in displayed members, fetch from API
          try {
            const response = await fetch(`/api/members/flat?query=${memberId}`);
            if (response.ok) {
              const members = await response.json();
              member = members.find(m => m.id == memberId);
              if (member && member.image && member.image_type) {
                member.image = `data:${member.image_type};base64,${this.bytesToBase64(member.image)}`;
              }
            }
          } catch (error) {
            console.error('Failed to fetch member:', error);
          }
        }
        
        if (member) {
          this.data.viewingMember = member;
          this.ui.showViewModal = true;
        }
      },
      
      async editMember(memberId) {
        // Find member in current displayed members first
        let member = this.data.displayedMembers.find(m => m.id == memberId);
        
        if (!member) {
          // If not found in displayed members, fetch from API
          try {
            const response = await fetch(`/api/members/flat?query=${memberId}`);
            if (response.ok) {
              const members = await response.json();
              member = members.find(m => m.id == memberId);
            }
          } catch (error) {
            console.error('Failed to fetch member:', error);
          }
        }
        
        if (member) {
          // Format birthday for date input if present
          const formattedMember = { ...member };
          if (member.birthday) {
            // Convert birthday to YYYY-MM-DD format for date input
            const date = new Date(member.birthday);
            if (!isNaN(date.getTime())) {
              formattedMember.birthday = date.toISOString().split('T')[0];
            }
          }
          
          this.data.editingMember = formattedMember;
          // Convert personal_info object to editPairs array
          this.forms.editPairs = member.personal_info ? 
            Object.entries(member.personal_info).map(([key, value]) => ({key, value})) : 
            [];
          this.ui.showEditModal = true;
        }
      },
      
      confirmDelete(memberId) {
        this.data.deletingMemberId = memberId;
        this.ui.showDeleteModal = true;
      },
      
      confirmDeleteMember() {
        if (this.data.deletingMemberId) {
          this.deleteMember(this.data.deletingMemberId);
        }
        this.ui.showDeleteModal = false;
      },
      
      // Bulk Actions
      bulkInvite() {
        if (this.data.selectedMembers.length === 0) {
          this.showNotification('warning', 'لا يوجد اختيار', 'يرجى اختيار أعضاء أولاً');
          return;
        }
        this.ui.showBulkInviteModal = true;
      },
      
      bulkDelete() {
        if (this.data.selectedMembers.length === 0) {
          this.showNotification('warning', 'لا يوجد اختيار', 'يرجى اختيار أعضاء أولاً');
          return;
        }
        
        if (confirm(`هل أنت متأكد من حذف ${this.data.selectedMembers.length} عضو؟\nهذه العملية لا يمكن التراجع عنها.`)) {
          this.processSelectedDeletions();
        }
      },
      
      async processSelectedDeletions() {
        for (const memberId of this.data.selectedMembers) {
          try {
            await this.deleteMember(memberId);
          } catch (error) {
            console.error(`Failed to delete member ${memberId}:`, error);
          }
        }
        this.data.selectedMembers = [];
        this.showNotification('success', 'تم الحذف', 'تم حذف الأعضاء المحددين بنجاح');
        setTimeout(() => location.reload(), 1000);
      },
      
      async sendBulkInvites() {
        if (!this.forms.bulkEmails.trim()) {
          this.showNotification('error', 'بيانات ناقصة', 'يرجى إدخال عناوين البريد الإلكتروني');
          return;
        }
        
        const emails = this.forms.bulkEmails.split(',').map(email => email.trim()).filter(email => email);
        if (emails.length === 0) {
          this.showNotification('error', 'بيانات غير صحيحة', 'يرجى إدخال عناوين بريد إلكتروني صحيحة');
          return;
        }
        
        try {
          // Process bulk invites (would need backend endpoint)
          for (const memberId of this.data.selectedMembers) {
            for (const email of emails) {
              await this.inviteMember(memberId, email);
            }
          }
          this.showNotification('success', 'تم الإرسال', `تم إرسال ${this.data.selectedMembers.length * emails.length} دعوة`);
          this.ui.showBulkInviteModal = false;
          this.forms.bulkEmails = '';
        } catch (error) {
          this.showNotification('error', 'خطأ في الإرسال', 'حدث خطأ أثناء إرسال الدعوات');
        }
      },
      
      // CRUD Operations
      async saveEditedMember() {
        if (!this.data.editingMember) return;
        
        try {
          const formData = new FormData();
          
          // Basic fields
          formData.append('name', this.data.editingMember.name);
          formData.append('last_name', this.data.editingMember.last_name);
          formData.append('gender', this.data.editingMember.gender);
          
          if (this.data.editingMember.birthday) {
            formData.append('birthday', this.data.editingMember.birthday);
          }
          if (this.data.editingMember.mother_id) {
            formData.append('mother_id', this.data.editingMember.mother_id);
          }
          if (this.data.editingMember.father_id) {
            formData.append('father_id', this.data.editingMember.father_id);
          }
          
          // Process personal info from editPairs
          const personalInfo = {};
          this.forms.editPairs.forEach(pair => {
            if (pair.key && pair.key.trim() && pair.value && pair.value.trim()) {
              personalInfo[pair.key.trim()] = pair.value.trim();
            }
          });
          formData.append('info', JSON.stringify(personalInfo));
          
          // Handle image upload if file is selected
          const imageInput = this.$refs.imageInput;
          if (imageInput && imageInput.files[0]) {
            // Validate image size (25MB limit)
            if (imageInput.files[0].size > 25 * 1024 * 1024) {
              this.showNotification('error', 'حجم الصورة كبير', 'يجب أن يكون حجم الصورة أقل من 25 ميجابايت');
              return;
            }
            const buf = await imageInput.files[0].arrayBuffer();
            formData.append('image', new Blob([buf], {type: imageInput.files[0].type}));
          }
          
          const response = await fetch(`/api/members/${this.data.editingMember.id}`, {
            method: 'PUT',
            body: formData
          });
          
          if (response.ok) {
            this.showNotification('success', 'تم التحديث', 'تم تحديث بيانات العضو بنجاح');
            this.ui.showEditModal = false;
            setTimeout(() => location.reload(), 1000);
          } else {
            const error = await response.json();
            this.showNotification('error', 'فشل التحديث', error.error || 'حدث خطأ أثناء التحديث');
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
        }
      },
      
      // Add new member function
      async newMember(e) {
        if (this.ui.loading) return;
        
        const formElement = e.target;
        
        // Validate required fields
        const name = formElement.querySelector('input[name="name"]').value.trim();
        const lastName = formElement.querySelector('input[name="last_name"]').value.trim();
        const gender = formElement.querySelector('select[name="gender"]').value;
        
        if (!name || !lastName || !gender) {
          this.showNotification('error', 'خطأ في النموذج', 'يرجى ملء جميع الحقول المطلوبة');
          return;
        }
        
        this.ui.loading = true;
        const formData = new FormData();

        // Process form fields
        for (const el of formElement.querySelectorAll("input[name], select[name]")) {
          if (el.name === "image" && el.files[0]) {
            // Validate image size (25MB limit)
            if (el.files[0].size > 25 * 1024 * 1024) {
              this.showNotification('error', 'حجم الصورة كبير', 'يجب أن يكون حجم الصورة أقل من 25 ميجابايت');
              this.ui.loading = false;
              return;
            }
            const buf = await el.files[0].arrayBuffer();
            formData.append(el.name, new Blob([buf], {type: el.files[0].type}));
          } else if (el.value) {
            formData.append(el.name, el.value);
          }
        }

        // Process personal info pairs
        let personalInfo = {};
        this.forms.newMemberPairs.forEach(pair => {
          if (pair.key && pair.key.trim() && pair.value && pair.value.trim()) {
            personalInfo[pair.key.trim()] = pair.value.trim();
          }
        });
        
        if (Object.keys(personalInfo).length > 0) {
          formData.append("info", JSON.stringify(personalInfo));
        }

        try {
          const response = await fetch("/api/members", {
            method: "POST",
            body: formData
          });

          if (response.status === 200) {
            this.showNotification('success', 'تم إضافة العضو', `تم إضافة ${name} ${lastName} بنجاح`);
            // Reset form
            formElement.reset();
            this.forms.newMemberPairs = [{ key: '', value: '' }];
            this.ui.showAddModal = false;
            setTimeout(() => location.reload(), 1500);
          } else {
            const body = await response.json().catch(() => ({}));
            this.showNotification('error', 'فشل في إضافة العضو', body.error || 'حدث خطأ غير متوقع');
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
        } finally {
          this.ui.loading = false;
        }
      },
      
      // CSV Upload Handler
      async handleCsvUpload(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        if (!file.name.toLowerCase().endsWith('.csv')) {
          this.showNotification('error', 'نوع ملف غير صحيح', 'يجب أن يكون الملف من نوع CSV');
          return;
        }
        
        const formData = new FormData();
        formData.append('members_csv', file);
        
        try {
          this.ui.loading = true;
          const response = await fetch('/api/members/import', {
            method: 'POST',
            body: formData
          });
          
          if (response.ok) {
            this.showNotification('success', 'تم الرفع', 'تم استيراد قائمة الأعضاء بنجاح');
            setTimeout(() => location.reload(), 1500);
          } else {
            const error = await response.json();
            this.showNotification('error', 'فشل الرفع', error.error || 'حدث خطأ أثناء رفع الملف');
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
        } finally {
          this.ui.loading = false;
          event.target.value = ''; // Reset file input
        }
      },
      
      // Navigation Functions
      membersPrevPage() {
        if (this.data.currentPage > 0) {
          this.data.currentPage--;
          this.loadMembers();
        }
      },
      
      membersNextPage() {
        // For server-side pagination, we check if current page has full results
        // If it has less than perPage, we're on the last page
        const hasMorePages = this.data.displayedMembers.length >= this.data.perPage;
        if (hasMorePages) {
          this.data.currentPage++;
          this.loadMembers();
        }
      },
      
      // Member invite function
      async inviteMember(id, email) {
        if (!email || !email.includes('@')) {
          this.showNotification('error', 'خطأ في البريد', 'يرجى إدخال بريد إلكتروني صحيح');
          return;
        }
        
        try {
          const response = await fetch(`/api/members/invite/${id}`, {
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
            body: JSON.stringify({
              email: email,
            })
          });

          if (response.status === 200) {
            this.showNotification('success', 'تم إرسال الدعوة', `تم إرسال دعوة إلى ${email}`);
            return true;
          } else {
            const body = await response.json();
            this.showNotification('error', 'فشل في إرسال الدعوة', body.error || 'حدث خطأ غير متوقع');
            return false;
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
          return false;
        }
      },
      
      async deleteMember(id) {
        try {
          const response = await fetch(`/api/members/${id}`, {
            method: "DELETE",
          });
          
          if (response.status === 200) {
            this.showNotification('success', 'تم حذف العضو', 'تم حذف العضو بنجاح');
            setTimeout(() => location.reload(), 1000);
            return true;
          } else {
            this.showNotification('error', 'فشل في الحذف', 'حدث خطأ أثناء حذف العضو');
            return false;
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
          return false;
        }
      },
      
      // Scroll to requests section with smooth animation
      scrollToRequests() {
        // Switch to requests tab
        this.ui.activeTab = 'requests';
        
        // Add highlight effect after tab switch
        setTimeout(() => {
          const requestsSection = document.getElementById('requests-section');
          if (requestsSection) {
            requestsSection.classList.add('ring-2', 'ring-amber-300', 'ring-opacity-50');
            setTimeout(() => {
              requestsSection.classList.remove('ring-2', 'ring-amber-300', 'ring-opacity-50');
            }, 2000);
          }
        }, 100);
      },
      
      // Logout function
      async logout() {
        if (!confirm('هل أنت متأكد من تسجيل الخروج؟')) {
          return;
        }
        
        try {
          const response = await fetch("/api/users/logout");
          if (response.status === 200) {
            this.showNotification('success', 'تم تسجيل الخروج', 'إلى اللقاء');
            setTimeout(() => {
              window.location.href = "/login";
            }, 1000);
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ', 'حدث خطأ أثناء تسجيل الخروج');
        }
      },
      
      // Request Management Functions
      async approveRequest(requestId) {
        if (!confirm('هل أنت متأكد من الموافقة على هذا الطلب؟')) {
          return;
        }
        
        try {
          const response = await fetch(`/api/members/requests/${requestId}/approve`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          if (response.ok) {
            this.showNotification('success', 'تم القبول', 'تم قبول الطلب بنجاح');
            // Remove the request from the list
            this.data.allAddRequests = this.data.allAddRequests.filter(req => req.id !== requestId);
            this.data.totalAddRequests = this.data.allAddRequests.length;
            // Reload page to get updated member list
            setTimeout(() => location.reload(), 1500);
          } else {
            const error = await response.json();
            this.showNotification('error', 'فشل في القبول', error.error || 'حدث خطأ أثناء قبول الطلب');
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
        }
      },
      
      async rejectRequest(requestId) {
        if (!confirm('هل أنت متأكد من رفض هذا الطلب؟\nهذه العملية لا يمكن التراجع عنها.')) {
          return;
        }
        
        try {
          const response = await fetch(`/api/members/requests/${requestId}/reject`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });
          
          if (response.ok) {
            this.showNotification('success', 'تم الرفض', 'تم رفض الطلب');
            // Remove the request from the list
            this.data.allAddRequests = this.data.allAddRequests.filter(req => req.id !== requestId);
            this.data.totalAddRequests = this.data.allAddRequests.length;
          } else {
            const error = await response.json();
            this.showNotification('error', 'فشل في الرفض', error.error || 'حدث خطأ أثناء رفض الطلب');
          }
        } catch (error) {
          console.error(error);
          this.showNotification('error', 'خطأ في الاتصال', 'يرجى المحاولة مرة أخرى');
        }
      },
      
      viewRequest(requestId) {
        // Find the request in the data
        const request = this.data.allAddRequests.find(req => req.id === requestId);
        if (request) {
          // Use the same viewing modal as for members
          this.data.viewingMember = request;
          this.ui.showViewModal = true;
        }
      },
      
      // Notification helper function
      showNotification(type, title, message) {
        // Check if global notification functions exist (from base template)
        if (typeof showSuccess === 'function' && type === 'success') {
          showSuccess(title, message);
        } else if (typeof showError === 'function' && type === 'error') {
          showError(title, message);
        } else if (typeof showWarning === 'function' && type === 'warning') {
          showWarning(title, message);
        } else {
          // Fallback to browser alert if notification functions don't exist
          alert(`${title}: ${message}`);
        }
      }
    }
  }
  
  // Enhanced Image Handler Component
  function imageHandler(member) {
    return {
      imageState: 'loading', // loading, user-image, generated-avatar, default-icon, error
      retryCount: 0,
      maxRetries: 2,
      loadTimeout: null,
      
      initImage() {
        // Reset state
        this.imageState = 'loading';
        this.retryCount = 0;
        
        // Set loading timeout (5 seconds)
        this.loadTimeout = setTimeout(() => {
          if (this.imageState === 'loading') {
            this.fallbackToAvatar();
          }
        }, 5000);
        
        // Start the fallback chain
        this.tryUserImage();
      },
      
      tryUserImage() {
        if (member && member.image) {
          // Try to load user image
          const img = new Image();
          img.onload = () => {
            this.clearTimeout();
            this.imageState = 'user-image';
          };
          img.onerror = () => {
            this.onImageError();
          };
          img.src = member.image;
        } else {
          // No user image, fallback to generated avatar
          this.fallbackToAvatar();
        }
      },
      
      onImageLoad() {
        this.clearTimeout();
        this.imageState = 'user-image';
      },
      
      onImageError() {
        this.clearTimeout();
        
        if (this.retryCount < this.maxRetries) {
          this.retryCount++;
          // Retry after a short delay
          setTimeout(() => {
            this.tryUserImage();
          }, 1000 * this.retryCount);
        } else {
          // Max retries reached, fallback to generated avatar
          this.fallbackToAvatar();
        }
      },
      
      fallbackToAvatar() {
        this.clearTimeout();
        if (member && (member.name || member.last_name)) {
          this.imageState = 'generated-avatar';
        } else {
          this.imageState = 'default-icon';
        }
      },
      
      retryImage() {
        this.retryCount = 0;
        this.initImage();
      },
      
      clearTimeout() {
        if (this.loadTimeout) {
          clearTimeout(this.loadTimeout);
          this.loadTimeout = null;
        }
      },
      
      // Generate initials from Arabic names
      extractInitials(name, lastName) {
        const firstName = (name || '').trim();
        const lastNameStr = (lastName || '').trim();
        
        let initials = '';
        
        // Get first character from first name
        if (firstName) {
          initials += firstName.charAt(0);
        }
        
        // Get first character from last name
        if (lastNameStr && lastNameStr !== firstName) {
          initials += lastNameStr.charAt(0);
        }
        
        // Fallback to "؟" if no initials found
        return initials || '؟';
      },
      
      // Generate consistent color based on member ID
      generateColorFromId(id) {
        if (!id) return { primary: '#6b7280', secondary: '#4b5563' };
        
        // Use member ID to generate consistent colors
        const hash = id * 2654435761 % (2**32);
        const hue = hash % 360;
        
        return {
          primary: `hsl(${hue}, 65%, 55%)`,
          secondary: `hsl(${hue}, 75%, 45%)`
        };
      },
      
      // Get avatar CSS class based on gender
      getAvatarClass(gender) {
        if (gender === 'male') {
          return 'avatar-male';
        } else if (gender === 'female') {
          return 'avatar-female';
        } else {
          return 'bg-gradient-to-br from-gray-500 to-gray-700 text-white';
        }
      },
      
      // Generate SVG avatar
      generateAvatar(memberData) {
        if (!memberData) return '';
        
        const initials = this.extractInitials(memberData.name, memberData.last_name);
        const colors = this.generateColorFromId(memberData.id);
        
        // Use CSS classes for gender-specific colors, or generated colors for unknown gender
        if (memberData.gender === 'male' || memberData.gender === 'female') {
          return `
            <div class="text-xl font-bold" style="text-shadow: 0 1px 2px rgba(0,0,0,0.1);">
              ${initials}
            </div>
          `;
        } else {
          return `
            <div class="text-xl font-bold text-white" 
                 style="background: linear-gradient(135deg, ${colors.primary}, ${colors.secondary}); text-shadow: 0 1px 2px rgba(0,0,0,0.2); width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;">
              ${initials}
            </div>
          `;
        }
      },
      
      // Generate proper alt text in Arabic
      generateAltText(memberData) {
        if (!memberData) return 'صورة عضو';
        
        const name = memberData.name || '';
        const lastName = memberData.last_name || '';
        const fullName = `${name} ${lastName}`.trim();
        
        if (fullName) {
          return `صورة ${fullName}`;
        } else {
          return `صورة عضو رقم ${memberData.id || 'غير معروف'}`;
        }
      }
    };
  }
</script>
{% endblock %}
