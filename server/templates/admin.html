{% extends "base.html" %}

{% block title %}صفحة الإدارة{% endblock %}

{% block content %}
<div dir="rtl" class="mx-auto space-y-8 p-8 font-sans bg-gray-100" x-data="adminPage()">
  <div class="flex justify-between items-center">
    <span class="text-lg font-bold">اهلا، {{ name }}!</span>
    <button @click="logout()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">تسجيل الخروج</button>
  </div>

  <form class="bg-white p-6 rounded shadow-md space-y-4" @submit.prevent="newMember($event)">
    <h2 class="text-xl font-bold mb-2">إضافة عضو جديد</h2>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div><label class="block mb-1">الاسم:</label><input dir="auto" name="name" type="text"
          class="w-full border rounded px-3 py-2" /></div>
      <div><label class="block mb-1">الاسم الاخير:</label><input dir="auto" name="last_name" type="text"
          class="w-full border rounded px-3 py-2" /></div>
      <div>
        <label class="block mb-1">الجنس:</label>
        <select name="gender" class="w-full border rounded px-3 py-2">
          <option selected value>-- اختر الجنس --</option>
          <option value="male">ذكر</option>
          <option value="female">انثى</option>
        </select>
      </div>
      <div><label class="block mb-1">تاريخ الولادة:</label><input dir="auto" name="birthday" type="date"
          class="w-full border rounded px-3 py-2" /></div>
      <div>
        <label for="new-mother_id" class="block mb-1">معرف الام:</label>
        <input name="mother_id" type="text" id="new-mother_id" list="new-mother_ids"
          class="w-full border rounded px-3 py-2" />
        <datalist id="new-mother_ids">
          {% for member in members %}
          {% if member.gender == "female" %}
          <option value="{{member.id}}">{{ member.id }} {{ member.name }}</option>
          {% endif %}
          {% endfor %}
        </datalist>
      </div>
      <div>
        <label for="new-father_id" class="block mb-1">معرف الاب:</label>
        <input name="father_id" id="new-father_id" type="text" list="new-father_ids"
          class="w-full border rounded px-3 py-2" />
        <datalist id="new-father_ids">
          {% for member in members %}
          {% if member.gender == "male" %}
          <option value="{{member.id}}">{{ member.id }} {{ member.name }}</option>
          {% endif %}
          {% endfor %}
        </datalist>
      </div>
    </div>

    <div class="space-y-2">
      <label class="block mb-1">معلومات شخصية:</label>
      <div class="space-y-1">
        <template x-for="(pair, index) in newMemberPairs" :key="index">
          <div class="flex gap-2">
            <input dir="auto" x-model="pair.key" type="text" class="border rounded px-3 py-2"
              placeholder="مثال: المهنة" />
            <input dir="auto" x-model="pair.value" type="text" class="border rounded px-3 py-2"
              placeholder="مثال: محامي" />
            <button type="button" @click="newMemberPairs.splice(index, 1)"
              class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">x</button>
          </div>
        </template>
      </div>
      <button type="button" @click="newMemberPairs.push({key: '', value: ''})" class="text-blue-500 hover:underline">+
        إضافة حقل</button>
    </div>

    <div>
      <label class="block mb-1">الصورة:</label>
      <input dir="auto" class="border px-2 py-1 rounded" name="image" type="file" class="w-full" />
    </div>

    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded">إضافة عضو</button>
  </form>

  <div class="bg-white p-6 rounded shadow space-y-4">
    <h2 class="text-xl font-bold mb-2">طلبات إضافة الأفراد</h2>

    <div>
      <form class="flex gap-2 items-center" @submit.prevent="requestsSearch($event)">
        {% match requests_query %}
        {% when Some with (query) %}
        <input name="query" dir="auto" type="text" value="{{ query }}" class="border px-3 py-2 rounded w-full" />
        {% when None %}
        <input name="query" dir="auto" type="text" class="border px-3 py-2 rounded w-full" />
        {% endmatch %}
        <button class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">ابحث</button>
      </form>
    </div>

    <div class="overflow-auto">
      <table class="table-auto w-full border border-gray-300 mt-4 text-center">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">معرف الطلب</th>
            <th class="p-2 border">الاسم</th>
            <th class="p-2 border">الاسم الاخير</th>
            <th class="p-2 border">الجنس</th>
            <th class="p-2 border">تاريخ الولادة</th>
            <th class="p-2 border">معرف الاب</th>
            <th class="p-2 border">معرف الام</th>
            <th class="p-2 border">معلومات شخصية</th>
            <th class="p-2 border">الصورة</th>
            <th class="p-2 border">الدعوات</th>
            <th colspan="2" class="p-2 border">إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for requested_member in add_requests %}
          {% if requested_member.status == RequestStatus::Pending %}
          <tr>
            <td class="p-2 border">{{ requested_member.id|e }}</td>
            <td class="p-2 border">{{ requested_member.name|e }}</td>
            <td class="p-2 border">{{ requested_member.last_name|e }}</td>
            {% if requested_member.gender == "male" %}
            <td class="p-2 border">ذكر</td>
            {% else if requested_member.gender == "female" %}
            <td class="p-2 border">انثى</td>
            {% endif %}
            {% match requested_member.birthday %}
            {% when Some with (birthday) %}
            <td class="p-2 border">{{ birthday|e }}</td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match requested_member.father_id %}
            {% when Some with (father_id) %}
            <td class="p-2 border">{{ father_id|e }}</td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match requested_member.mother_id %}
            {% when Some with (mother_id) %}
            <td class="p-2 border">{{ mother_id|e }}</td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match requested_member.personal_info %}
            {% when Some with (personal_info) %}
            <td class="p-2 border">
              {% for (key, value) in personal_info %}
              <span>{{key}}: {{value}}</span>
              {% endfor %}
            </td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match requested_member.image %}
            {% when Some with (image) %}
            {% match requested_member.image_type %}
            {% when Some with (image_type) %}
            <td class="p-2 border" style="max-width: 10rem;">
              <img style="max-width: 100%;" src="data:{{ image_type }};base64, {{ image|bytes_to_base64 }}" />
            </td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            <td class="p-2 border">
              <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
                @click="confirmDisapprove('{{ requested_member.id }}')">الرفض</button>
            </td>
            <td class="p-2 border">
              <button class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded"
                @click="confirmApprove('{{ requested_member.id }}')">القبول</button>
            </td>
          </tr>
          {% endif %}
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="flex justify-between mt-4">
      <button @click="requestsPrevPage()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">الصفحة
        السابقة</button>
      <button @click="requestsNextPage()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">الصفحة
        التالية</button>
    </div>
  </div>

  <div class="bg-white p-6 rounded shadow space-y-4">
    <h2 class="text-xl font-bold mb-2">الدعوات البريدية</h2>

    <div class="overflow-auto">
      <table class="table-auto w-full border border-gray-300 mt-4 text-center">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">معرف الدعوة</th>
            <th class="p-2 border">معرف العضو</th>
            <th class="p-2 border">البريد</th>
            <th class="p-2 border">حالة الدعوة</th>
            <th class="p-2 border">ارسلت في</th>
            <th class="p-2 border">تنتهي في</th>
          </tr>
        </thead>
        <tbody>
          {% for invite in member_invites %}
          <tr>
            <td>{{ invite.id }}</td>
            <td>{{ invite.member_id }}</td>
            <td>{{ invite.email }}</td>
            <td>
              {% match invite.status %}
              {% when Pending %}
              معلًق
              {% when Accepted %}
              قبل
              {% when Declined %}
              رفض
              {% endmatch %}
            </td>
            <td>{{ invite.created_at }}</td>
            <td>{{ invite.expires_at }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="flex justify-between mt-4">
      <button @click="invitesPrevPage()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">الصفحة
        السابقة</button>
      <button @click="invitesNextPage()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">الصفحة
        التالية</button>
    </div>
  </div>

  <div class="bg-white p-6 rounded shadow space-y-4">
    <div class="flex flex-wrap items-center justify-between gap-4">
      <a href="/api/members/export" download="exported-members.csv">
        <button class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">تصدير قائمة العائلة</button>
      </a>
      <form @submit.prevent="uploadMembers($event)" enctype="multipart/form-data" class="flex items-center gap-2">
        <input dir="auto" type="file" name="members_csv" accept="text/csv" class="border px-2 py-1 rounded" />
        <button type="submit" class="bg-purple-500 hover:bg-purple-600 text-white px-3 py-1 rounded">رفع
          القائمة</button>
      </form>
    </div>

    <div>
      <form class="flex items-center gap-2" @submit.prevent="membersSearch($event)">
        {% match members_query %}
        {% when Some with (query) %}
        <input name="query" dir="auto" type="text" value="{{ query }}" class="border px-3 py-2 rounded w-full" />
        {% when None %}
        <input name="query" dir="auto" type="text" class="border px-3 py-2 rounded w-full" />
        {% endmatch %}
        <button class="bg-gray-700 hover:bg-gray-800 text-white px-4 py-2 rounded">ابحث</button>
      </form>
    </div>

    <div class="overflow-auto">
      <table class="table-auto w-full border border-gray-300 mt-4 text-center">
        <thead class="bg-gray-200">
          <tr>
            <th class="p-2 border">المعرف</th>
            <th class="p-2 border">الاسم</th>
            <th class="p-2 border">الاسم الاخير</th>
            <th class="p-2 border">الجنس</th>
            <th class="p-2 border">تاريخ الولادة</th>
            <th class="p-2 border">معرف الاب</th>
            <th class="p-2 border">معرف الام</th>
            <th class="p-2 border">معلومات شخصية</th>
            <th class="p-2 border">الصورة</th>
            <th class="p-2 border">الدعوات</th>
            <th colspan="3" class="p-2 border">إجراءات</th>
          </tr>
        </thead>
        <tbody>
          {% for member in members %}
          <tr x-data="{ editing: false, editPairs: [] }">
            <td class="p-2 border">{{ member.id|e }}</td>
            <td class="p-2 border">{{ member.name|e }}</td>
            <td class="p-2 border">{{ member.last_name|e }}</td>
            {% if member.gender == "male" %}
            <td class="p-2 border">ذكر</td>
            {% else if member.gender == "female" %}
            <td class="p-2 border">انثى</td>
            {% endif %}
            {% match member.birthday %}
            {% when Some with (birthday) %}
            <td class="p-2 border">{{ birthday|e }}</td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match member.father_id %}
            {% when Some with (father_id) %}
            <td class="p-2 border">{{ father_id|e }}</td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match member.mother_id %}
            {% when Some with (mother_id) %}
            <td class="p-2 border">{{ mother_id|e }}</td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match member.personal_info %}
            {% when Some with (personal_info) %}
            <td class="p-2 border">
              {% for (key, value) in personal_info %}
              <span>{{key}}: {{value}}</span>
              {% endfor %}
            </td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% match member.image %}
            {% when Some with (image) %}
            {% match member.image_type %}
            {% when Some with (image_type) %}
            <td class="p-2 border" style="max-width: 10rem;">
              <img style="max-width: 100%;" src="data:{{ image_type }};base64, {{ image|bytes_to_base64 }}" />
            </td>
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            {% when None %}
            <td class="p-2 border">NULL</td>
            {% endmatch %}
            <td x-data="{ email: '' }" class="p-2 border">
              <input type="email" class="border px-3 py-2 rounded w-full" x-model="email" />

              <button class="bg-yellow-500 hover:bg-yellow-600 text-white my-2 px-4 py-2 rounded"
                @click="inviteMember({{ member.id }}, email)">دعوة بريدية</button>
            </td>
            <td class="p-2 border">
              <button class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded"
                @click="confirmDelete({{ member.id }})">حذف</button>
            </td>
            <td dir="rtl" class="p-2 border text-right">
              <button class="bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded" @click="editing = !editing; if(editing) { editPairs = [
                  {% match member.personal_info %}
                  {% when Some with (personal_info) %}
                  {% for (key, value) in personal_info %}
                  {key: '{{key}}', value: '{{value}}'},
                  {% endfor %}
                  {% when None %}
                  {% endmatch %}
                ]; }" x-text="editing ? 'إغلاق التعديل' : 'تعديل'"></button>

              <form x-show="editing" x-transition @submit.prevent="editMember($event, {{ member.id }})"
                class="mt-2 space-y-2" enctype="multipart/form-data">
                <div>
                  <label>الاسم:</label>
                  <input dir="auto" x-on:change="$el.classList.add('changed')" class="w-full border rounded px-3 py-2"
                    type="text" name="name" value="{{ member.name }}" />
                </div>
                <div>
                  <label>الاسم الاخير:</label>
                  <input dir="auto" x-on:change="$el.classList.add('changed')" class="w-full border rounded px-3 py-2"
                    type="text" name="last_name" value="{{ member.last_name }}" />
                </div>
                <div>
                  <label>الجنس:</label>
                  <select x-on:change="$el.classList.add('changed')" class="w-full border rounded px-3 py-2"
                    name="gender">
                    {% if member.gender == "male" %}
                    <option selected value="male">ذكر</option>
                    <option value="female">انثى</option>
                    {% else if member.gender == "female" %}
                    <option value="male">ذكر</option>
                    <option selected value="female">انثى</option>
                    {% endif %}
                  </select>
                </div>
                <div>
                  <label>تاريخ الولادة:</label>
                  {% match member.birthday %}
                  {% when Some with (birthday) %}
                  <input dir="auto" x-on:change="$el.classList.add('changed')" class="w-full border rounded px-3 py-2"
                    type="date" name="birthday" value="{{ birthday.format(" %Y-%m-%d").to_string() }}" />
                  {% when None %}
                  <input dir="auto" x-on:change="$el.classList.add('changed')" class="w-full border rounded px-3 py-2"
                    type="date" name="birthday" />
                  {% endmatch %}
                </div>
                <div>
                  <label>معرف الام:</label>
                  {% match member.mother_id %}
                  {% when Some with (mother_id) %}
                  <input x-on:change="$el.classList.add('changed')" name="mother_id" type="text"
                    list="edit-mother_ids-{{member.id}}" class="w-full border rounded px-3 py-2"
                    value="{{mother_id}}" />
                  {% when None %}
                  <input x-on:change="$el.classList.add('changed')" name="mother_id" type="text"
                    list="edit-mother_ids-{{member.id}}" class="w-full border rounded px-3 py-2" />
                  {% endmatch %}
                  <datalist id="edit-mother_ids-{{member.id}}">
                    {% for other_member in members %}
                    {% if other_member.gender == "female" && other_member.id != member.id %}
                    <option value="{{other_member.id}}">{{ other_member.id }} {{ other_member.name }}</option>
                    {% endif %}
                    {% endfor %}
                  </datalist>
                </div>
                <div>
                  <label>معرف الاب:</label>
                  {% match member.father_id %}
                  {% when Some with (father_id) %}
                  <input x-on:change="$el.classList.add('changed')" name="father_id" type="text"
                    list="edit-father_ids-{{member.id}}" class="w-full border rounded px-3 py-2"
                    value="{{father_id}}" />
                  {% when None %}
                  <input x-on:change="$el.classList.add('changed')" name="father_id" type="text"
                    list="edit-father_ids-{{member.id}}" class="w-full border rounded px-3 py-2" />
                  {% endmatch %}
                  <datalist id="edit-father_ids-{{member.id}}">
                    {% for other_member in members %}
                    {% if other_member.gender == "male" && other_member.id != member.id %}
                    <option value="{{other_member.id}}">{{ other_member.id }} {{ other_member.name }}</option>
                    {% endif %}
                    {% endfor %}
                  </datalist>
                </div>
                <div>
                  <label>المعلومات الشخصية:</label>
                  <div class="space-y-1">
                    <template x-for="(pair, index) in editPairs" :key="index">
                      <div class="flex gap-2">
                        <input dir="auto" x-model="pair.key" class="border rounded px-3 py-2"
                          placeholder="مثال: المهنة" />
                        <input dir="auto" x-model="pair.value" class="border rounded px-3 py-2"
                          placeholder="مثال: محامي" />
                        <button type="button" @click="editPairs.splice(index, 1)"
                          class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">x</button>
                      </div>
                    </template>
                  </div>
                  <button type="button" @click="editPairs.push({key: '', value: ''})"
                    class="text-blue-500 hover:underline">+ إضافة حقل</button>
                </div>
                <div>
                  <label>الصورة:</label>
                  <input dir="auto" x-on:change="$el.classList.add('changed')" class="border px-2 py-1 rounded"
                    type="file" name="image" />
                </div>
                <button class="my-3 bg-indigo-500 hover:bg-indigo-600 text-white px-3 py-1 rounded" type="submit">إرسال
                  التعديل</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="flex justify-between mt-4">
      <button @click="membersPrevPage()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">الصفحة السابقة</button>
      <button @click="membersNextPage()" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded">الصفحة التالية</button>
    </div>
  </div>
</div>

<script>
  function adminPage() {
    return {
      newMemberPairs: [],

      async inviteMember(id, email) {
        try {
          const response = await fetch(`/api/members/invite/${id}`, {
            headers: {
              "Content-Type": "application/json",
            },
            method: "POST",
            body: JSON.stringify({
              email: email,
            })
          });

          if (response.status === 200) {
            location.reload();
          } else {
            const body = await response.json();
            alert(body.error);
          }
        } catch (error) {
          console.error(error);
        }
      },

      async membersSearch(e) {
        const formData = new FormData(e.target);
        const searchParams = new URLSearchParams(window.location.search);
        const query = formData.get("query");

        if (query === "") {
          searchParams.delete("members_query");
        } else {
          searchParams.set("members_query", query);
        }
        window.location.search = searchParams.toString();
      },

      async requestsSearch(e) {
        const formData = new FormData(e.target);
        const searchParams = new URLSearchParams(window.location.search);
        const query = formData.get("query");

        if (query === "") {
          searchParams.delete("requests_query");
        } else {
          searchParams.set("requests_query", query);
        }
        window.location.search = searchParams.toString();
      },

      membersNextPage() {
        const searchParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(searchParams.get("members_page")) || 0;
        searchParams.set("members_page", currentPage + 1);
        window.location.search = searchParams.toString();
      },

      membersPrevPage() {
        const searchParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(searchParams.get("members_page")) || 0;
        if (currentPage > 0) {
          searchParams.set("members_page", currentPage - 1);
          window.location.search = searchParams.toString();
        }
      },

      requestsNextPage() {
        const searchParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(searchParams.get("requests_page")) || 0;
        searchParams.set("requests_page", currentPage + 1);
        window.location.search = searchParams.toString();
      },

      requestsPrevPage() {
        const searchParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(searchParams.get("requests_page")) || 0;
        if (currentPage > 0) {
          searchParams.set("requests_page", currentPage - 1);
          window.location.search = searchParams.toString();
        }
      },

      invitesNextPage() {
        const searchParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(searchParams.get("invites_page")) || 0;
        searchParams.set("invites_page", currentPage + 1);
        window.location.search = searchParams.toString();
      },

      invitesPrevPage() {
        const searchParams = new URLSearchParams(window.location.search);
        const currentPage = parseInt(searchParams.get("invites_page")) || 0;
        if (currentPage > 0) {
          searchParams.set("invites_page", currentPage - 1);
          window.location.search = searchParams.toString();
        }
      },

      async logout() {
        const response = await fetch("/api/users/logout");
        if (response.status === 200) {
          window.location.href = "/admin/login";
        }
      },

      async newMember(e) {
        const formElement = e.target;
        const formData = new FormData();

        for (const el of formElement.querySelectorAll("input[name], select[name]")) {
          if (el.name === "image" && el.files[0]) {
            const buf = await el.files[0].arrayBuffer();
            formData.append(el.name, new Blob([buf], {type: el.files[0].type}));
          } else {
            formData.append(el.name, el.value);
          }
        }

        let personalInfo = {};
        this.newMemberPairs.forEach(pair => {
          if (pair.key) {
            personalInfo[pair.key] = pair.value;
          }
        });
        formData.append("info", JSON.stringify(personalInfo));

        try {
          const response = await fetch("/api/members", {
            method: "POST",
            body: formData
          });

          if (response.status === 200) {
            location.reload();
          } else {
            const body = await response.json();
            alert(body.error);
          }
        } catch (error) {
          console.error(error);
        }
      },

      confirmDelete(id) {
        if (confirm("هل أنت متأكد أنك تريد حذف هذا العضو؟")) {
          this.deleteMember(id);
        }
      },

      async deleteMember(id) {
        const response = await fetch(`/api/members/${id}`, {
          method: "DELETE",
        });
        if (response.status === 200) {
          location.reload();
        }
      },

      confirmDisapprove(id) {
        if (confirm("هل أنت متأكد أنك تريد رفض هذا العضو؟")) {
          this.disapproveRequest(id);
        }
      },

      async disapproveRequest(id) {
        const response = await fetch(`/api/members/disapprove/${id}`, {
          method: "PUT",
        });
        if (response.status === 200) {
          location.reload();
        }
      },

      confirmApprove(id) {
        if (confirm("هل أنت متأكد أنك تريد قبول هذا العضو؟")) {
          this.approveRequest(id);
        }
      },

      async approveRequest(id) {
        const response = await fetch(`/api/members/approve/${id}`, {
          method: "PUT",
        });
        if (response.status === 200) {
          location.reload();
        }
      },

      async editMember(e, id) {
        const formElement = e.target;
        const formData = new FormData();

        for (const el of formElement.querySelectorAll("input[name].changed, select[name].changed")) {
          if (el.name === "image" && el.files[0]) {
            const buf = await el.files[0].arrayBuffer();
            formData.append(el.name, new Blob([buf], {type: el.files[0].type}));
          } else {
            formData.append(el.name, el.value);
          }
        }

        const row = formElement.closest('tr');
        const editPairs = row._x_dataStack[0].editPairs;
        const personalInfo = {};

        editPairs.forEach(pair => {
          if (pair.key) {
            personalInfo[pair.key] = pair.value;
          }
        });
        formData.append("info", JSON.stringify(personalInfo));

        const res = await fetch(`/api/members/${id}`, {
          method: "PUT",
          body: formData,
        });

        if (res.status === 200) {
          location.reload();
        }
      },

      async uploadMembers(event) {
        const formElement = event.target;
        const formData = new FormData(formElement);

        const res = await fetch("/api/members/import", {
          method: "POST",
          body: formData,
        });

        if (res.status === 200) {
          location.reload();
        }
      }
    }
  }
</script>
{% endblock %}